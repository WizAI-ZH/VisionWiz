<!DOCTYPE html>
<html>
  <template id="portTemplate">
    <div class="port-option">
      <span class="com-path"></span>
      <span class="device-info"></span>
    </div>
  </template>

  <script>
    // ä¿®æ”¹è®¾å¤‡åˆ—è¡¨åŠ è½½é€»è¾‘
    async function refreshPorts() {
      const ports = await ipcRenderer.invoke("get-ports");
      const template = document.getElementById("portTemplate");

      if (ports.length === 0) {
        document.getElementById(
          "portList"
        ).innerHTML = `<div class="no-device">âš ï¸ æœªæ£€æµ‹åˆ°CH340è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>`;
      } else {
        const fragment = document.createDocumentFragment();
        ports.forEach((p) => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".com-path").textContent = p.path;
          clone.querySelector(".device-info").textContent = `${
            p.manufacturer || "æœªçŸ¥å‚å•†"
          } (${p.serialNumber || "æ— åºåˆ—å·"})`;
          fragment.appendChild(clone);
        });
        document.getElementById("portList").appendChild(fragment);
      }
    }
  </script>

  <style>
    .port-option {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .no-device {
      color: #ff4444;
      padding: 12px;
    }
  </style>

  <body>
    <select id="portList"></select>
    <button id="connectBtn">Connect</button>
    <div id="status"></div>

    <script>
      const { ipcRenderer } = require("electron");

      // å¢å¼ºç‰ˆè®¾å¤‡åˆ—è¡¨åˆ·æ–°
      async function refreshPorts() {
        try {
          const ports = await ipcRenderer.invoke("get-ports");
          const select = document.getElementById("portList");

          // æ¸…ç©ºç°æœ‰é€‰é¡¹
          select.innerHTML = "";

          // åŠ¨æ€åˆ›å»ºé€‰é¡¹
          ports.forEach((port) => {
            const option = document.createElement("option");
            option.value = port.path;
            option.textContent = `${port.path} (CH340)`;
            select.appendChild(option);
          });

          // æ— è®¾å¤‡æç¤º
          if (ports.length === 0) {
            const option = document.createElement("option");
            option.textContent = "æœªæ£€æµ‹åˆ°è®¾å¤‡";
            select.disabled = true;
            select.appendChild(option);
          } else {
            select.disabled = false;
          }
        } catch (err) {
          console.error("åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥:", err);
        }
      }

      // åˆå§‹åŒ–åŠ è½½ + è‡ªåŠ¨åˆ·æ–°
      document.addEventListener("DOMContentLoaded", () => {
        refreshPorts();
        // æ·»åŠ å®šæ—¶åˆ·æ–°
        setInterval(refreshPorts, 2000);
      });

      // è¿æ¥æŒ‰é’®å¤„ç†
      document
        .getElementById("connectBtn")
        .addEventListener("click", async () => {
          const path = document.getElementById("portList").value;
          try {
            await ipcRenderer.invoke("connect-port", path);
            document.getElementById("status").innerHTML = "ğŸ”‘ æ­£åœ¨éªŒè¯å¯†é’¥...";
          } catch (err) {
            alert(`è¿æ¥å¤±è´¥: ${err.message}`);
          }
        });
    </script>
  </body>
</html>
